<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Blockchain Diary List</title>
    <style>
        * { margin: 0; padding: 0; box-sizing: border-box; }
        body {
            font-family: 'Segoe UI', 'Roboto', 'Helvetica Neue', Arial, 'PingFang SC', 'Hiragino Sans GB', 'Microsoft YaHei', sans-serif;
            background: linear-gradient(135deg, #fffde7 0%, #fff9c4 100%);
            min-height: 100vh;
            display: flex;
            align-items: flex-start;
            justify-content: center;
            padding: 32px 0 32px 0;
            overflow: hidden;
        }
        .container {
            background: rgba(255, 255, 255, 0.98);
            border-radius: 28px;
            box-shadow: 0 12px 48px rgba(230, 193, 85, 0.18), 0 2px 8px #ffe08244;
            padding: 48px 36px 36px 36px;
            max-width: 1100px;
            width: 98vw;
            min-height: 700px;
            backdrop-filter: blur(10px);
            animation: fadeIn 0.6s ease-out;
            overflow: hidden;
        }
        .diary-list-wrap {
            position: relative;
            background: none;
            border-radius: 18px;
            box-shadow: none;
            margin: 0 auto;
            max-width: 100%;
        }
        .tab-bar {
            position: sticky;
            top: 0;
            z-index: 10;
            background: rgba(255,255,255,0.98);
            border-top-left-radius: 18px;
            border-top-right-radius: 18px;
            box-shadow: 0 2px 8px #ffe08222;
        }
        @keyframes fadeIn {
            from { opacity: 0; transform: translateY(20px); }
            to { opacity: 1; transform: translateY(0); }
        }
        h1 {
            color: #e6c155;
            margin-bottom: 36px;
            text-align: center;
            font-size: 2.8em;
            font-weight: 700;
            letter-spacing: 2px;
            text-shadow: 0 4px 16px #ffe08244, 0 2px 8px #fffbe6;
        }
        .diary-list {
            display: flex;
            flex-wrap: wrap;
            gap: 18px 18px;
            justify-content: flex-start;
            min-height: 700px;
            max-height: 700px;
            overflow: auto;
            padding: 16px;
        }
        .diary-card {
            background: linear-gradient(135deg, #fffbe6 60%, #ffe082 100%);
            border-radius: 20px;
            box-shadow: 0 6px 24px rgba(230, 193, 85, 0.16), 0 1.5px 6px #ffe08233;
            padding: 16px 12px 10px 12px;
            width: 250px;
            height: 150px;
            min-width: 250px;
            max-width: 250px;
            min-height: 150px;
            max-height: 150px;
            flex: 0 0 250px;
            cursor: pointer;
            transition: box-shadow 0.18s, transform 0.18s;
            position: relative;
            border: 2.5px solid #ffe082;
            overflow: hidden;
            display: flex;
            flex-direction: column;
            justify-content: flex-start;
        }
        .diary-card:hover {
            box-shadow: 0 12px 36px rgba(230, 193, 85, 0.22), 0 2px 8px #ffe08255;
            transform: translateY(-4px) scale(1.025);
            border-color: #e6c155;
        }
        .diary-title-preview {
            color: #bfae6a;
            font-size: 1em;
            font-weight: 700;
            margin-bottom: 6px;
            letter-spacing: 1px;
            text-shadow: 0 2px 8px #fffbe6;
            overflow: hidden;
            text-overflow: ellipsis;
            white-space: nowrap;
        }
        .diary-content-preview {
            color: #6d5c1c;
            font-size: 0.98em;
            line-height: 1.4;
            margin-bottom: 8px;
            word-break: break-all;
            min-height: 30px;
            max-height: 2.5em;
            overflow: hidden;
            text-overflow: ellipsis;
            display: -webkit-box;
            -webkit-line-clamp: 2;
            -webkit-box-orient: vertical;
        }
        .diary-meta {
            font-size: 1em;
            color: #bfa94a;
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-top: auto;
        }
        .diary-meta .author {
            font-weight: 700;
            color: #e6c155;
            font-size: 1.05em;
            letter-spacing: 0.5px;
        }
        .diary-meta .date {
            font-size: 0.98em;
            color: #bfa94a;
        }
        .empty-tip {
            text-align: center;
            color: #bfa94a;
            margin-top: 60px;
            font-size: 1.2em;
        }
        .modal {
            display: none;
            position: fixed;
            z-index: 1000;
            left: 0; top: 0; right: 0; bottom: 0;
            background: rgba(0,0,0,0.25);
            align-items: center;
            justify-content: center;
        }
        .modal.active { display: flex; }
        .modal-content {
            background: linear-gradient(135deg, #fffde7 60%, #ffe082 100%);
            border-radius: 22px;
            box-shadow: 0 12px 48px rgba(230, 193, 85, 0.22), 0 2px 8px #ffe08244;
            padding: 56px 48px 40px 48px;
            max-width: 1200px;
            max-height: 700px;
            width: 98vw;
            height: 700px !important;
            position: relative;
            animation: fadeIn 0.3s;
            overflow-y: auto;
        }
        .modal-footer {
            position: absolute;
            left: 0;
            right: 0;
            bottom: 0;
            background: linear-gradient(90deg, #fffbe6 60%, #ffe082 100%);
            border-bottom-left-radius: 22px;
            border-bottom-right-radius: 22px;
            box-shadow: 0 -2px 12px #ffe08233;
            padding: 18px 48px 14px 48px;
            display: flex;
            justify-content: space-between;
            align-items: center;
            font-size: 1.05em;
            color: #bfa94a;
            z-index: 2;
        }
        .modal-footer .author { color: #e6c155; font-weight: 700; }
        .modal-footer .date { color: #bfa94a; }
        .modal-footer a { color: #1976d2; text-decoration: underline; margin-left: 12px; }
        .modal-close {
            position: absolute;
            right: 22px;
            top: 18px;
            font-size: 1.7em;
            color: #e6c155;
            background: none;
            border: none;
            cursor: pointer;
            font-weight: bold;
        }
        .modal-content .diary-content-full {
            color: #6d5c1c;
            font-size: 1.18em;
            line-height: 1.9;
            margin-bottom: 22px;
            word-break: break-all;
            white-space: pre-line;
        }
        .modal-content .diary-title-full {
            color: #bfae6a;
            font-size: 1.35em;
            font-weight: 700;
            margin-bottom: 18px;
            letter-spacing: 1px;
            text-shadow: 0 2px 8px #fffbe6;
        }
        @media (max-width: 900px) {
            .container { padding: 12px 2vw; }
            h1 { font-size: 2em; }
            .diary-list { gap: 10px; }
            .diary-card { min-width: 90vw; max-width: 98vw; padding: 16px 8px 10px 8px; }
            .modal-footer { padding: 12px 10px 10px 10px; font-size: 0.98em; }
        }
        .top-btn {
            font-weight: 900;
            font-size: 1.08em;
            color: #7c6a2c;
            background: linear-gradient(90deg, #fffde7 0%, #ffe082 100%);
            text-shadow: none;
            border: none;
            border-radius: 16px;
            padding: 10px 0;
            width: 160px;
            min-width: 160px;
            max-width: 160px;
            box-shadow: 0 4px 18px #e6c15533, 0 1.5px 6px #ffe08233;
            cursor: pointer;
            transition: background 0.18s, color 0.18s, box-shadow 0.18s, transform 0.18s;
            letter-spacing: 1px;
            margin: 0;
            display: flex;
            align-items: center;
            justify-content: center;
            overflow: hidden;
            text-overflow: ellipsis;
            white-space: nowrap;
        }
        .top-btn:hover {
            background: linear-gradient(90deg, #ffe082 0%, #fffde7 100%);
            color: #fff;
            text-shadow: 0 2px 8px #bfae6a, 0 1px 0 #fff;
        }
        .tab-btn {
            background: #fffbe6 !important;
            color: #bfae6a !important;
            font-weight: 700;
            border: none;
            box-shadow: 0 2px 8px #ffe08222;
            transition: all 0.18s;
        }
        .tab-btn.active {
            background: linear-gradient(90deg, #ffe082 0%, #ffe082 100%) !important;
            color: #fff !important;
            font-weight: 900 !important;
            box-shadow: 0 4px 16px #e6c15588 !important;
            border: 2.5px solid #e6c155 !important;
            transform: scale(1.04);
        }
        @media (max-width: 600px) {
            #editor-modal-inner {
                max-width: 98vw !important;
                width: 98vw !important;
            }
            #editor-iframe {
                width: 98vw !important;
                min-width: 0 !important;
                height: 90vh !important;
                min-height: 300px !important;
                max-height: 90vh !important;
            }
        }
        .main-card {
            background: #fff;
            border-radius: 20px;
            box-shadow: var(--gold-shadow);
            border: 2px solid var(--gold-border);
            padding: 40px 18px 32px 18px;
            max-width: 1200px;
            margin: 0 auto;
            min-height: 600px;
            height: 80vh;
            display: flex;
            flex-direction: column;
            justify-content: flex-start;
        }
        .btn-primary, .btn-wallet {
            width: auto;
            min-width: 220px;
            max-width: 100%;
            box-sizing: border-box;
            display: flex;
            align-items: center;
            justify-content: center;
        }

        /* Loading spinner */
        @keyframes spin { to { transform: rotate(360deg); } }
        .spinner {
            position: absolute;
            top: 50%; left: 50%;
            width: 64px; height: 64px;
            margin: -32px 0 0 -32px;
            border: 6px solid #ffe08255;
            border-top-color: #e6c155;
            border-radius: 50%;
            animation: spin 0.8s linear infinite;
            z-index: 20;
            display: none;
        }
    </style>
</head>
<body>
    <div style="position:fixed;top:24px;right:36px;z-index:100;display:flex;flex-direction:column;gap:14px;align-items:flex-end;">
      <button id="global-wallet-btn" class="top-btn wallet" style="width:160px;">Connect Wallet</button>
      <button id="create-diary-btn" class="top-btn create" style="width:160px;">Create Diary</button>
      <!-- Language toggle button -->
      <button id="language-btn" class="top-btn wallet" style="width:160px;">繁體中文</button>
    </div>
    <div style="position:fixed;top:24px;left:36px;z-index:100;display:flex;flex-direction:column;gap:14px;align-items:flex-start;">
      <button id="chatroom-btn" class="top-btn create" style="min-width:120px;">Chat Room</button>
    </div>
    <div class="container">
        <div style="display:flex;align-items:center;justify-content:center;gap:14px;margin-bottom:36px;">
          <img src="t.png" alt="Logo" style="width:56px;height:56px;object-fit:contain;"/>
          <h1 id="main-title" style="margin:0;">Blockchain Diary List</h1>
        </div>
        <div class="diary-list-wrap">
          <div class="tab-bar" id="tabBar" style="display:flex;gap:18px;justify-content:center;margin-bottom:0;">
            <button id="tab-public" class="tab-btn active" style="font-size:1.1em;padding:8px 28px;border-radius:18px;border:none;background:#ffe082;color:#bfae6a;font-weight:700;box-shadow:0 2px 8px #ffe08233;cursor:pointer;">Public Diaries</button>
            <button id="tab-private" class="tab-btn" style="font-size:1.1em;padding:8px 28px;border-radius:18px;border:none;background:#fffbe6;color:#bfae6a;font-weight:700;box-shadow:0 2px 8px #ffe08222;cursor:pointer;">My Private Diaries</button>
            <span id="wallet-tip" style="display:none;color:#bfae6a;font-size:0.98em;margin-left:18px;align-self:center;">Please connect your wallet to view private diaries</span>
          </div>
          <div class="diary-list" id="diaryList"></div>
          <div class="empty-tip" id="emptyTip" style="display:none;">No diaries yet, write one now!</div>
        </div>
    </div>
    <div class="modal" id="modal">
        <div class="modal-content">
            <button class="modal-close" id="modalClose">×</button>
            <div class="diary-title-full" id="modalTitle"></div>
            <div class="diary-content-full" id="modalContent"></div>
            <div class="modal-footer" id="modalFooter"></div>
        </div>
    </div>
    <!-- 日记编辑器弹窗 -->
    <div id="editor-modal" style="display:none;position:fixed;z-index:2000;top:0;left:0;width:100vw;height:100vh;background:rgba(0,0,0,0.18);backdrop-filter:blur(2px);align-items:center;justify-content:center;">
      <div id="editor-modal-inner" style="background:#fffbe6;padding:0;border-radius:18px;box-shadow:0 8px 32px #e6c15555;max-width:1400px;width:98vw;max-height:98vh;display:flex;flex-direction:column;position:relative;">
        <button id="close-editor-modal" style="position:absolute;top:12px;right:18px;font-size:1.8em;color:#bfae6a;background:none;border:none;cursor:pointer;z-index:10;">×</button>
        <div id="editor-loading" class="spinner"></div>
        <iframe id="editor-iframe" src="" style="width:96vw;min-width:320px;max-width:1400px;height:90vh;min-height:400px;max-height:90vh;border:none;border-radius:18px;background:#fff;"></iframe>
      </div>
    </div>
    <!-- 聊天室弹窗 -->
    <div id="chat-modal" style="display:none;position:fixed;z-index:2000;top:0;left:0;width:100vw;height:100vh;background:rgba(0,0,0,0.18);backdrop-filter:blur(2px);align-items:center;justify-content:center;">
      <div id="chat-modal-inner" style="background:#fffbe6;padding:0;border-radius:18px;box-shadow:0 8px 32px #e6c15555;max-width:1000px;width:96vw;max-height:96vh;display:flex;flex-direction:column;position:relative;">
        <button id="close-chat-modal" style="position:absolute;top:12px;right:18px;font-size:1.8em;color:#bfae6a;background:none;border:none;cursor:pointer;z-index:10;">×</button>
        <div id="chat-loading" class="spinner"></div>
        <iframe id="chat-iframe" src="" style="width:94vw;min-width:320px;max-width:1000px;height:88vh;min-height:400px;max-height:88vh;border:none;border-radius:18px;background:#fff;"></iframe>
      </div>
    </div>
    <!-- Corner decorative images -->
    <img src="piexel-dog.png" alt="Pixel Dog" style="position:fixed;bottom:24px;left:36px;width:180px;height:180px;object-fit:contain;pointer-events:none;z-index:80;"/>
    <img src="piexel-dog2.png" alt="Pixel Dog 2" style="position:fixed;bottom:24px;right:36px;width:180px;height:180px;object-fit:contain;pointer-events:none;z-index:80;"/>
    <!-- Chat summary sidebar -->
    <div id="chat-summary" style="position:fixed;top:100px;left:36px;width:180px;z-index:90;background:rgba(255,255,255,0.7);box-shadow:0 4px 18px #e6c15533;border-radius:18px;padding:14px 12px;display:flex;flex-direction:column;gap:10px;">
      <div style="font-weight:900;color:#bfae6a;font-size:1.05em;display:flex;align-items:center;gap:6px;">
        <i class="fas fa-comment-dots"></i> <span id="chat-summary-title">Recent Chats</span>
      </div>
      <ul id="chatSummaryList" style="list-style:none;margin:0;padding:0;display:flex;flex-direction:column;gap:6px;font-size:0.9em;color:#6d5c1c;max-height:220px;overflow:auto;"></ul>
    </div>
    <script type="module">
    import { initializeApp } from "https://www.gstatic.com/firebasejs/9.23.0/firebase-app.js";
    import { getDatabase, ref, onValue, onChildAdded, query, limitToLast } from "https://www.gstatic.com/firebasejs/9.23.0/firebase-database.js";
    const firebaseConfig = {
      apiKey: "AIzaSyA5Z5ieEbAcfQX0kxGSn9ldGXhzvAwx_8M",
      authDomain: "chat-294cc.firebaseapp.com",
      databaseURL: "https://chat-294cc-default-rtdb.firebaseio.com",
      projectId: "chat-294cc",
      storageBucket: "chat-294cc.firebasestorage.app",
      messagingSenderId: "913615304269",
      appId: "1:913615304269:web:0274ffaccb8e6b678e4e04",
      measurementId: "G-SJR9NDW86B"
    };
    const app = initializeApp(firebaseConfig);
    const db = getDatabase(app);

    /* ============== i18n section ============== */
    const langTexts = {
      'en': {
        connectWallet: 'Connect Wallet',
        createDiary: 'Create Diary',
        chatRoom: 'Chat Room',
        blockchainDiaryList: 'Blockchain Diary List',
        publicDiaries: 'Public Diaries',
        privateDiaries: 'My Private Diaries',
        walletTip: 'Please connect your wallet to view private diaries',
        emptyTip: 'No diaries yet, write one now!',
        emptyTipNoWallet: 'Please connect your wallet to view your private diaries',
        clickToView: 'Click to view full text',
        recentChats: 'Recent Chats',
        untitled: 'Untitled',
        anonymous: 'Anonymous'
      },
      'zh-TW': {
        connectWallet: '連接錢包',
        createDiary: '創建日記',
        chatRoom: '聊天室',
        blockchainDiaryList: '區塊鏈日記列表',
        publicDiaries: '公開日記',
        privateDiaries: '我的私密日記',
        walletTip: '請連接您的錢包以查看私密日記',
        emptyTip: '尚未有日記，立即開始撰寫！',
        emptyTipNoWallet: '請連接您的錢包以查看您的私密日記',
        clickToView: '點擊查看全文',
        recentChats: '近期聊天',
        untitled: '未命名',
        anonymous: '匿名'
      }
    };

    let currentLang = 'zh-TW';
    function t(key){ return langTexts[currentLang][key] || key; }

    function applyLanguage(){
      // buttons on top right
      if(!currentWallet){ globalWalletBtn.textContent = t('connectWallet'); }
      document.getElementById('create-diary-btn').textContent = t('createDiary');
      document.getElementById('language-btn').textContent = currentLang === 'en' ? '繁體中文' : 'English';
      // top left chatroom button
      document.getElementById('chatroom-btn').textContent = t('chatRoom');
      // page title
      document.getElementById('main-title').textContent = t('blockchainDiaryList');
      // tabs
      document.getElementById('tab-public').textContent = t('publicDiaries');
      document.getElementById('tab-private').textContent = t('privateDiaries');
      // wallet tip
      document.getElementById('wallet-tip').textContent = t('walletTip');
      // chat summary title
      const chatSumTitle = document.getElementById('chat-summary-title');
      if(chatSumTitle) chatSumTitle.textContent = t('recentChats');
      // re-render current tab so empty tips & diaries localize
      renderCurrentTab();
    }

    function toggleLanguage(){
      currentLang = currentLang === 'en' ? 'zh-TW' : 'en';
      applyLanguage();
    }

    document.getElementById('language-btn').onclick = toggleLanguage;
    /* ============ end i18n section ============ */
    // 钱包连接（仅用于私密日记过滤）
    let currentWallet = '';
    // 全局钱包连接按钮
    const globalWalletBtn = document.getElementById('global-wallet-btn');
    // 生成短地址展示
    function shortAddr(addr) {
      if (!addr || addr.length < 8) return addr;
      return addr.slice(0, 4) + '...' + addr.slice(-6);
    }
    // 連接 Phantom 錢包
    async function connectWalletGlobal() {
      if (window.solana && window.solana.isPhantom) {
        try {
          const resp = await window.solana.connect();
          currentWallet = resp.publicKey.toString();
          globalWalletBtn.textContent = shortAddr(currentWallet);
          document.getElementById('wallet-tip').style.display = 'none';
          renderCurrentTab();
        } catch (e) {}
      } else {
        alert('Please install Phantom wallet');
      }
    }
    globalWalletBtn.onclick = connectWalletGlobal;
    document.getElementById('tab-private').onclick = function() {
      setTab('private');
    };
    document.getElementById('tab-public').onclick = function() {
      setTab('public');
    };
    function setTab(tab) {
      currentTab = tab;
      document.getElementById('tab-public').classList.remove('active');
      document.getElementById('tab-private').classList.remove('active');
      document.getElementById('tab-' + tab).classList.add('active');
      renderCurrentTab();
    }
    let allDiaries = [];
    let currentTab = 'public';
    // 初始套用語言，現在 currentTab 已定義
    applyLanguage();
    function renderCurrentTab() {
      if (currentTab === 'private') {
        const emptyTip = document.getElementById('emptyTip');
        if (!currentWallet) {
          document.getElementById('wallet-tip').style.display = '';
          renderDiaries([]);
          emptyTip.textContent = t('emptyTipNoWallet');
          emptyTip.style.display = '';
          return;
        }
        document.getElementById('wallet-tip').style.display = 'none';
        emptyTip.textContent = t('emptyTip');
        const privateDiaries = allDiaries.filter(d => d.public === false && d.wallet === currentWallet);
        renderDiaries(privateDiaries);
      } else {
        document.getElementById('wallet-tip').style.display = 'none';
        const emptyTip = document.getElementById('emptyTip');
        emptyTip.textContent = t('emptyTip');
        const publicDiaries = allDiaries.filter(d => d.public !== false);
        renderDiaries(publicDiaries);
      }
    }
    // 获取最新的30条日记
    function fetchDiaries(callback) {
      const diaryRef = query(ref(db, 'diaryEntries'), limitToLast(30));
      onValue(diaryRef, (snapshot) => {
        const val = snapshot.val();
        if (!val) return callback([]);
        // 转为数组并按时间倒序
        const arr = Object.entries(val).map(([id, entry]) => ({ id, ...entry })).sort((a, b) => b.timestamp - a.timestamp);
        callback(arr);
      });
    }
    // 渲染日记卡片
    function renderDiaries(diaries) {
      const diaryList = document.getElementById('diaryList');
      const emptyTip = document.getElementById('emptyTip');
      diaryList.innerHTML = '';
      if (!diaries.length) {
        emptyTip.style.display = '';
        return;
      }
      emptyTip.style.display = 'none';
      diaries.forEach((d) => {
        const card = document.createElement('div');
        card.className = 'diary-card';
        card.title = t('clickToView');
        // 标题
        let title = d.title ? d.title : t('untitled');
        // 只显示前120字
        let preview = d.content ? (d.content.length > 120 ? d.content.slice(0, 120) + '...' : d.content) : '';
        card.innerHTML = `
          <div class="diary-title-preview">${escapeHtml(title)}</div>
          <div class="diary-content-preview">${escapeHtml(preview)}</div>
          <div class="diary-meta">
            <span class="author">${d.wallet ? (d.wallet.slice(0,4)+'...'+d.wallet.slice(-6)) : t('anonymous')}</span>
            <span class="date">${formatDate(d.timestamp)}</span>
          </div>
        `;
        card.addEventListener('click', () => showModal(d));
        diaryList.appendChild(card);
      });
    }
    // 弹窗显示全文
    function showModal(diary) {
      let txHtml = diary.txid ? `<a href=\"https://solscan.io/tx/${diary.txid}\" target=\"_blank\">Solscan</a>` : '';
      document.getElementById('modalTitle').innerHTML = escapeHtml(diary.title||t('untitled'));
      document.getElementById('modalContent').innerHTML = escapeHtml(diary.content||'');
      document.getElementById('modalFooter').innerHTML = `
        <span class="author">${diary.wallet ? (diary.wallet.slice(0,4)+'...'+diary.wallet.slice(-6)) : t('anonymous')}</span>
        <span class="date">${formatDate(diary.timestamp)}</span>
        ${txHtml}
      `;
      document.getElementById('modal').classList.add('active');
    }
    document.getElementById('modalClose').onclick = () => {
      document.getElementById('modal').classList.remove('active');
    };
    document.getElementById('modal').onclick = (e) => {
      if (e.target === document.getElementById('modal')) {
        document.getElementById('modal').classList.remove('active');
      }
    };
    // 工具函数
    function formatDate(ts) {
      if (!ts) return '';
      const date = new Date(ts);
      return date.toLocaleString('zh-CN', {year:'numeric',month:'2-digit',day:'2-digit',hour:'2-digit',minute:'2-digit'});
    }
    function escapeHtml(str) {
      if (!str) return '';
      return str.replace(/[&<>"']/g, function(tag) {
        const chars = {'&':'&amp;','<':'&lt;','>':'&gt;','"':'&quot;','\'':'&#39;'};
        return chars[tag] || tag;
      });
    }
    // 页面加载时拉取日记
    fetchDiaries(function(diaries){
      allDiaries = diaries;
      renderCurrentTab();
      applyLanguage(); // ensure language applied after data load
    });
    setTab('public');
    // 创建日记按钮 + 加载动画
    const editorIframe = document.getElementById('editor-iframe');
    const editorLoading = document.getElementById('editor-loading');
    document.getElementById('create-diary-btn').onclick = function() {
      editorLoading.style.display = 'block';
      document.getElementById('editor-modal').style.display = 'flex';
      editorIframe.src = 'Untitled.html';
    };
    editorIframe.onload = () => { editorLoading.style.display = 'none'; };
    document.getElementById('close-editor-modal').onclick = function() {
      document.getElementById('editor-modal').style.display = 'none';
      editorIframe.src = '';
      editorLoading.style.display = 'none';
    };
    // 聊天室按钮相关逻辑
    const chatroomBtn = document.getElementById('chatroom-btn');
    const chatIframe = document.getElementById('chat-iframe');
    const chatLoading = document.getElementById('chat-loading');
    chatroomBtn.onclick = function() {
      chatLoading.style.display = 'block';
      document.getElementById('chat-modal').style.display = 'flex';
      chatIframe.src = 'chat.html';
    };
    chatIframe.onload = () => { chatLoading.style.display = 'none'; };
    document.getElementById('close-chat-modal').onclick = function() {
      document.getElementById('chat-modal').style.display = 'none';
      chatIframe.src = '';
      chatLoading.style.display = 'none';
    };
    document.getElementById('chat-modal').onclick = function(e) {
      if (e.target === document.getElementById('chat-modal')) {
        document.getElementById('chat-modal').style.display = 'none';
        chatIframe.src = '';
        chatLoading.style.display = 'none';
      }
    };
    // Chat summary rendering
    const chatSummaryList = document.getElementById('chatSummaryList');
    const chatMessagesRef = ref(db, 'chatMessages');
    const summaryMsgs = [];
    function renderSummary() {
      chatSummaryList.innerHTML = '';
      summaryMsgs.slice().reverse().forEach(msg => {
        const li = document.createElement('li');
        li.style.whiteSpace = 'nowrap';
        li.style.overflow = 'hidden';
        li.style.textOverflow = 'ellipsis';
        li.textContent = msg.text;
        chatSummaryList.appendChild(li);
      });
    }
    onChildAdded(query(chatMessagesRef, limitToLast(5)), snap => {
      const val = snap.val();
      summaryMsgs.push(val);
      if (summaryMsgs.length > 5) summaryMsgs.shift();
      renderSummary();
    });
    </script>
</body>
</html> 
